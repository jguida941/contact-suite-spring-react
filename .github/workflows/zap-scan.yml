name: ZAP DAST Scan

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  zap-baseline:
    name: ZAP Baseline Scan
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: contactapp
          POSTGRES_USER: contactapp
          POSTGRES_PASSWORD: contactapp
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U contactapp"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build application
        run: mvn package -DskipTests -q

      - name: Start application
        run: |
          java -jar target/cs320-contact-service-junit-1.0.0-SNAPSHOT.jar \
            --spring.profiles.active=dev \
            --spring.datasource.url=jdbc:postgresql://localhost:5432/contactapp \
            --spring.datasource.username=contactapp \
            --spring.datasource.password=contactapp \
            --jwt.secret=dGVzdC1zZWNyZXQta2V5LWZvci1kZXZlbG9wbWVudC1vbmx5LWRvLW5vdC11c2UtaW4tcHJvZHVjdGlvbg== &
          echo "Waiting for application to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/actuator/health | grep -q '"status":"UP"'; then
              echo "Application started successfully"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-baseline-report
          path: report_html.html
          retention-days: 30

  zap-api-scan:
    name: ZAP API Scan
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: contactapp
          POSTGRES_USER: contactapp
          POSTGRES_PASSWORD: contactapp
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U contactapp"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build application
        run: mvn package -DskipTests -q

      - name: Start application
        run: |
          java -jar target/cs320-contact-service-junit-1.0.0-SNAPSHOT.jar \
            --spring.profiles.active=dev \
            --spring.datasource.url=jdbc:postgresql://localhost:5432/contactapp \
            --spring.datasource.username=contactapp \
            --spring.datasource.password=contactapp \
            --jwt.secret=dGVzdC1zZWNyZXQta2V5LWZvci1kZXZlbG9wbWVudC1vbmx5LWRvLW5vdC11c2UtaW4tcHJvZHVjdGlvbg== &
          echo "Waiting for application to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/actuator/health | grep -q '"status":"UP"'; then
              echo "Application started successfully"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: ZAP API Scan
        uses: zaproxy/action-api-scan@v0.7.0
        with:
          target: 'http://localhost:8080/v3/api-docs'
          format: openapi
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l WARN'
          allow_issue_writing: false

      - name: Upload ZAP API Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-api-report
          path: report_html.html
          retention-days: 30
